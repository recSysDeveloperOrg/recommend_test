# 电影推荐系统
## 前期准备

### 熟悉推荐系统算法
推荐看《推荐系统实践》这一本书，在turing社区可以购买https://www.ituring.com.cn/book/894

这里结合MovieLens的数据集，我大概介绍一下这个推荐系统可能使用到的算法

在我们的电影推荐系统中，两部电影之间会通过各种各样的方式形成关联，这些方式包括：
- 根据电影关键词构造关键词向量，计算向量之间的相似性
- 根据用户行为计算电影之间的相似性（最简单来说，我们定义相似性为同时看过两部电影的人数），然后结合用户评分进行概率预测，排序推荐（推荐）
- 根据标签进行推荐（推荐）

下面简单介绍这几种算法：
#### 利用电影关键字进行相关推荐
我们定义电影关键词向量如下：
$$
d=\{(k_1,w_1), (k_2,w_2)...(k_n,w_n)\}
$$

其中$k_i$表示关键词$i$，$w_i$表示这个关键词的权重，计算关键词权重最著名的方法是TF-IDF方法，TF表示词频，IDF是逆文档频率，逆文档频率的定义如下：
$$
IDF=log(\frac{|D|}{|D_i|})
$$

其中$|D|$表示所有的文档总数，$|D_i|$表示文档中出现了相关关键词的文档总数
$$
TF-IDF=TF*IDF
$$

在电影推荐系统中，由于关键字频率不好统计，所以更倾向于使用其他关键信息并赋予权重进行预测，例如将电影中的演员作为关键词，演员重要性作为权重。

#### 利用用户行为计算电影之间的相似性
刚才我们说过，电影$i$和电影$j$之间的相似性可以简单定义为：
$$
w_{ij}=|N(i) \cap N(j)|
$$

其中$|N(i)|$表示对电影$i$发生过行为（例如评分）的不同的用户总数
去除人数对于相似性的影响，修改$w_{ij}$为余玄相似度
$$
w_{ij}=\frac{|N(i) \cap N(j)|}{\sqrt{|N(i)|*|N(j)|}}
$$

考虑到有专业的职业影评会对许多电影做出评价，所以需要惩罚分子，降低这些职业影评或者非法数据对于电影相似度的影响
$$
w_{ij}=\frac{\sum_{u\in N(i)\cap N(j)} \frac{1}{log(1+N(u))}}{\sqrt{|N(i)|*|N(j)|}}
$$

其中$N(u)$表示用户$u$的评价总数

随后可以正则化$w_{ij}$，即
$$
w_{ij}=\frac{w_{ij}}{max(w_{i})}
$$

现在我们得到了电影相似度矩阵$w$，我们要预测用户$u$是否对电影$i$感兴趣，只需要根据用户的历史感兴趣记录与相似度矩阵便可求得：
$$
p_{ui}=\sum_{j\in N(u) \cap S(i,K)} r_{uj}*w_{ji}
$$

这里$N(u)$表示用户喜欢的电影列表（根据用户历史评分记录取得），$S(i,K)$表示与电影$i$最相近的$K$的电影列表，$r_{uj}$表示用户$u$对电影$j$的评分，$w_{ji}$表示电影$j$和电影$i$的相似度。换句话来说，我们将用户喜欢的电影列表按用户的评分倒排，取前$K$大对应的电影，求和每一部电影与预测电影的相似度乘上用户对这部电影的评分即可。

#### 根据标签进行推荐
有的时候，单一的推荐系统得到的结果并不是最理想的，我们可以组合多种推荐系统，经过过滤和排名获得最终的推荐结果，这里介绍另外一种推荐系统，其思想和ItemCF的思想类似，都是在用户已有的行为结果上求解最优推荐结果

根据标签推荐的原理很简单，我们根据用户打的标签得到被打上这些标签次数最多的电影集合即可，当然结果只需要简单地过滤用户已经打上标签的电影集合即可。

即用户$u$对一个电影$i$的兴趣如下：
$$
p_{ui}=\sum_t n_{ut}*n_{it}
$$

$n_{ut}$表示用户$u$打标签$t$的次数，$n_{it}$表示电影$i$被不同用户打上标签$t$的次数

这里需要考虑两个惩罚，第一个惩罚是对热门标签的惩罚，因为用户可能打上一个很热门的标签，从而降低了推荐的多样性，第二个惩罚是对热门电影的惩罚。
修改后的兴趣如下：
$$
p_{ui}=\sum_t \frac{n_{ut}}{log(1+N_t)}*\frac{n_{it}}{log(1+N_i)}
$$

$N_t$表示使用标签$t$的用户总数，$N_i$表示对电影$i$打过标签的用户总数

##### 标签的数据稀疏问题
由于每个用户的表达方式不一致，所得到的标签内容也不一致，所以需要计算标签之间的相似性，在推荐的时候需要将相似的标签纳入考虑范围，使用余玄相似度计算即可
$$
sim_{tt'}=\frac{\sum_i |n_{i,t} \cap n_{i,t'}|}{\sqrt{\sum_i |n_{i,t}|^2*\sum_i |n_{i,t'}|^2}}
$$

$n_{i,t}$表示在电影$i$打了标签$t$的用户集合

##### 标签清理
用户可能会打负面情绪的标签，或者用户不想看到这个标签，这种情况下我们提前避免将这个标签纳入推荐考虑的范畴。我认为最简单的实现方式是在前端页面给一个反馈窗口，让用户自己反馈是否觉得这个标签是对他合适的

### 爬取相关数据

由于这个推荐系统需要展现一个完整的前端界面，所以电影相关的信息(图片，简介，演员列表等等）需要从IMDB/TMDB上爬取下来

IMDB爬取url：
https://www.imdb.com/title/tt{imdbid}/?ref_=fn_al_tt_1

TMDB爬取url:
https://www.themoviedb.org/movie/{tmdbid}

## 系统架构设计

### 推荐系统设计

推荐系统需要实现的功能：
- 离线计算相似度矩阵
- 在线推荐
- 对推荐结果进行排序

接口设计：
```
message Response {
    i64 Code
    string Msg
}

message Movie {
    i64 Id
    string Name
    string PicUrl
    string Introduction
    string Participants
}

message RecommendResult {
    Response resp
    repeated Movie Movies
}

service Recommender {
    rpc recommendByRating(i64 userId) returns (RecommendResult) {}
    rpc recommendByTag(i64 userId) returns (RecommendResult) {}
} 
```

整体设计图：
![algorithm_module](https://www.ljygogogo.com/upload/2021/12/algorithm_module-d5a31d1f1ed94cd2aa4ae93616cb49fb.png)

### 后台系统设计

整体设计：
![backend_sys_architecture](https://www.ljygogogo.com/upload/2021/12/backend_sys_architecture-e3bda16863b94797b988d71b5ae6c924.png)

后台系统需要实现的功能：
- 用户模块（包括用户登录/注册/新用户冷启动模块）
- 权限模块（可选，有精力再加就行）
- 电影模块（包括新增/删除/修改/搜索/推荐电影/对电影评分）
- 标签模块（包括新增/删除/修改标签）
- 日志模块（主要记录/处理用户行为日志）

这里大概说明一下几个稍微复杂一点的功能流程

#### 新用户冷启动模块
![new_user_cold_start](https://www.ljygogogo.com/upload/2021/12/new_user_cold_start-2235c563a4f94f358bd73d87c43abbdf.png)

由于这里需要计算所有电影的推荐概率，所以可以考虑上spark算

#### 日志模块

日志主要是为了记录用户在进入网站之后的行为，优化推荐参数，要触发日志记录**必须要求用户已经登录**。这里我们主要记录以下日志：
- 用户搜索日志
- 链接访问日志
- 电影详情页停留时长日志

消费者的任务是根据日志信息适当调整用户的参数，使得推荐能够更加精确，特别是对于不喜欢评分的用户，我们可以把这些日志行为对应的电影当作其评分列表的一部分，再调整权重即可更加有效地推荐。


### 前端系统设计

前端需要做的页面如下：
- 首页（也就是个性化推荐）
- 电影详情页（需要有图片、标题、内容、参演人员、评分模块、标签模块）
- 搜索页面